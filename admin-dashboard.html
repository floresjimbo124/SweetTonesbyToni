<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo.PNG">
    <title>Admin Dashboard - Sweets by Toni</title>
    <link href="style.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: transparent;
        }
        
        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .admin-header h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.8rem;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        .export-btn, .refresh-btn, .logout-btn {
            padding: 10px 16px;
            min-height: 40px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .refresh-btn {
            background: var(--primary);
            color: white;
        }
        
        .refresh-btn:hover {
            background: var(--primary-dark);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .orders-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .limits-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .limits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        .limit-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            background: #fff;
        }
        .limit-item label { font-size: 0.85rem; color: var(--text-light); display:block; margin-bottom:6px; }
        .limit-item input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .limits-actions { margin-top: 12px; display:flex; gap:10px; justify-content:flex-end; }
        .save-limits-btn { background: #111827; color:#fff; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; transition: background 0.2s ease; }
        .save-limits-btn:hover { background: #1f2937; }
        .cancel-btn { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px 14px; cursor: pointer; transition: all 0.2s ease; }
        .cancel-btn:hover { background: #e5e7eb; }
        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fff;
        }
        
        /* Separate max-height for products table */
        .limits-container .table-scroll {
            max-height: 400px;
        }

        /* Dates Management Styles */
        .dates-management {
            margin-top: 20px;
        }

        .date-type-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .date-type-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .date-type-selector label:hover {
            background: #e9ecef;
        }

        .date-type-selector input[type="radio"] {
            margin: 0;
        }

        .date-type-selector input[type="radio"]:checked + span {
            color: #007bff;
            font-weight: 600;
        }

        .add-date-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .add-date-section h4 {
            margin: 0 0 25px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-date-section h4::before {
            content: "➕";
            font-size: 16px;
        }

        .date-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 20px;
            align-items: end;
        }

        .date-input-group .form-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group .form-field label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin: 0;
        }

        .date-input-group .form-field input,
        .date-input-group .form-field select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .date-input-group .form-field input:focus,
        .date-input-group .form-field select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .date-input-group .form-field input[type="date"] {
            cursor: pointer;
        }

        .date-input-group .form-field input[type="number"] {
            text-align: center;
        }

        .date-input-group .form-field input[type="text"] {
            flex: 1;
        }

        .add-date-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            height: fit-content;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-date-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .add-date-btn:active {
            transform: translateY(0);
        }

        .available-dates-section h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .available-dates-section h4::before {
            content: "📅";
            font-size: 16px;
        }

        .dates-list {
            display: grid;
            gap: 12px;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }

        .date-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .date-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .date-main {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            line-height: 1.3;
        }

        .date-details {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .date-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .date-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .edit-date-btn {
            background: #ffc107;
            color: #212529;
            border: 1px solid #ffc107;
        }

        .edit-date-btn:hover {
            background: #e0a800;
            border-color: #e0a800;
            transform: translateY(-1px);
        }

        .delete-date-btn {
            background: #dc3545;
            color: white;
            border: 1px solid #dc3545;
        }

        .delete-date-btn:hover {
            background: #c82333;
            border-color: #c82333;
            transform: translateY(-1px);
        }

        .date-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .date-status.available {
            background: #d4edda;
            color: #155724;
        }

        .date-status.full {
            background: #f8d7da;
            color: #721c24;
        }

        .date-status.past {
            background: #e2e3e5;
            color: #6c757d;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .date-input-group {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .date-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .date-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .date-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .date-type-selector {
                flex-direction: column;
                gap: 10px;
            }
            
            .add-date-section {
                padding: 20px 15px;
            }
            
            .date-item {
                padding: 15px;
            }
        }
        
        /* Custom scrollbar styling */
        .table-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .orders-header h2 {
            color: var(--primary);
            margin: 0;
        }
        
        .status-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .status-btn {
            padding: 6px 12px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .status-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .orders-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        /* Enhanced status toggle styles */
        .status-filter {
            background: #f8f9fb;
            border: 1px solid var(--border);
            padding: 6px;
            border-radius: 30px;
        }
        .status-btn {
            background: transparent;
            border: none;
            color: var(--text);
            padding: 8px 14px;
            border-radius: 999px;
            font-weight: 500;
        }
        .status-btn:hover {
            background: rgba(0,0,0,0.05);
        }
        .status-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .filters-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        
        .date-filter {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            background: #f8f9fb;
            border: 1px solid var(--border);
            padding: 6px 8px;
            border-radius: 12px;
        }
        
        .date-filter input[type="date"] {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: white;
            color: var(--text);
        }
        .date-filter label {
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .preset-filter {
            display: flex;
            gap: 6px;
        }
        .preset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 500;
            cursor: pointer;
        }
        .preset-btn:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .clear-filters-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .clear-filters-btn:hover {
            background: #f3f4f6;
        }

        /* Status badge improvements */
        .status-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid transparent;
        }
        .status-pending {
            background: #fff7e6;
            color: #b26a00;
            border-color: #ffe1b3;
        }
        .status-confirmed {
            background: #e6f7fb;
            color: #0b7285;
            border-color: #b8ecf7;
        }
        .status-completed {
            background: #e9f7ef;
            color: #1b5e20;
            border-color: #c9edd6;
        }
        .status-cancelled {
            background: #fdecea;
            color: #b71c1c;
            border-color: #f9c6c1;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
            min-width: 900px;
        }
        
        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            font-size: 0.85rem;
        }
        .status-save {
            margin-left: 6px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .status-save[disabled] {
            opacity: 0.6;
            cursor: default;
        }
        
        .orders-table thead th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
            z-index: 2;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
        }

        .orders-table tbody tr:nth-child(even) {
            background: #fbfcff;
        }
        .orders-table tbody tr:hover {
            background: #f6f8ff;
        }
        /* Product modal styles - shared between add and edit */
        #addProductModal .order-modal-content,
        #editProductModal .order-modal-content { 
            box-shadow: 0 20px 60px rgba(0,0,0,0.25); 
        }
        
        #addProductModal .order-modal-body .filters-group,
        #editProductModal .order-modal-body .filters-group { 
            background: #fbfbfd; 
            border: 1px solid var(--border); 
            padding: 20px;
        }
        
        /* Input field wrapper for currency prefix */
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-prefix {
            position: absolute;
            left: 12px;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
            z-index: 1;
        }
        
        #addProductModal input[type="text"],
        #addProductModal input[type="number"],
        #editProductModal input[type="text"],
        #editProductModal input[type="number"]{
            width: 100%;
            padding: 12px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            font-size: 14px;
            font-family: inherit;
            transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
        }
        
        /* Price inputs with currency prefix */
        #addProductModal input[type="number"].price-input,
        #editProductModal input[type="number"].price-input {
            padding-left: 32px;
            font-weight: 500;
        }
        
        /* Stock input styling */
        #addProductModal input[type="number"].stock-input,
        #editProductModal input[type="number"].stock-input {
            font-weight: 600;
            color: #059669;
        }
        
        #addProductModal input::placeholder,
        #editProductModal input::placeholder { 
            color: #9ca3af; 
        }
        
        #addProductModal input:focus,
        #editProductModal input:focus{
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.15);
            background: #fff;
        }
        
        #addProductModal input:hover:not(:focus):not([readonly]),
        #editProductModal input:hover:not(:focus):not([readonly]) {
            border-color: #d1d5db;
        }
        
        #addProductModal input[readonly],
        #editProductModal input[readonly] {
            background: #f9fafb;
            cursor: not-allowed;
            color: #6b7280;
        }
        
        #addProductModal label,
        #editProductModal label { 
            color: var(--text); 
            font-weight: 600; 
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        /* Image Upload Styling */
        .image-upload-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .image-url-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .image-url-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.1);
        }
        
        .image-file-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
            cursor: pointer;
        }
        
        .image-file-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.1);
        }
        
        .image-file-input:hover {
            border-color: var(--primary);
        }
        
        .remove-image-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }
        
        .remove-image-btn:hover {
            background: #dc2626;
        }
        
        .image-preview {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .image-preview-item {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview-label {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        
        #addProductModal .help-text,
        #editProductModal .help-text { 
            color: var(--text-light); 
            font-size: 12px; 
            margin-top: 4px; 
            display: block; 
        }
        
        /* Form field styling */
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-field label {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .field-icon {
            font-size: 12px;
            opacity: 0.7;
        }
        
        /* Modal animation */
        .order-modal {
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .order-modal.open .order-modal-content {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Better button states */
        .save-limits-btn:active {
            transform: scale(0.98);
        }
        
        .cancel-btn:active {
            transform: scale(0.98);
        }
        
        /* Input focus state enhancements */
        #addProductModal input[type="number"]:focus.price-input,
        #editProductModal input[type="number"]:focus.price-input {
            color: #059669;
        }
        
        #addProductModal input[type="number"]:focus.stock-input,
        #editProductModal input[type="number"]:focus.stock-input {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
        }
        
        /* Help text animation */
        .help-text {
            transition: color 0.2s ease;
        }
        
        .form-field:focus-within .help-text {
            color: var(--primary);
        }
        
        /* Variant editing styles */
        .variants-container {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .variant-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .variant-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.1);
        }
        
        .variant-item:last-child {
            margin-bottom: 0;
        }
        
        .variant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .variant-name {
            font-weight: 700;
            color: var(--text);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-name::before {
            content: "📏";
            font-size: 14px;
        }
        
        .variant-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            align-items: end;
        }
        
        .variant-field {
            display: flex;
            flex-direction: column;
        }
        
        .variant-field label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .variant-field input {
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .variant-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        .variant-field input:hover:not(:focus) {
            border-color: #d1d5db;
        }
        
        .variant-field .input-wrapper {
            position: relative;
        }
        
        .variant-field .input-wrapper .input-prefix {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: var(--text-light);
            font-weight: 600;
            z-index: 1;
        }
        
        .variant-field .input-wrapper input {
            padding-left: 32px;
        }
        
        /* Price field styling */
        .variant-field[data-field="price"] input {
            color: #059669;
            font-weight: 600;
        }
        
        /* Stock field styling */
        .variant-field[data-field="stock"] input {
            color: #dc2626;
            font-weight: 600;
        }
        
        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .variant-fields {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            
            /* Make product form single column on tablets */
            #addProductModal .order-modal-body .filters-group > div:first-child,
            #editProductModal .order-modal-body .filters-group > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
        }
        
        @media (max-width: 480px) {
            .variant-fields {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            /* Ensure single column on mobile */
            #addProductModal .order-modal-body .filters-group > div:first-child,
            #editProductModal .order-modal-body .filters-group > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
        }
        
        /* Currency prefix enhancement */
        .input-prefix {
            transition: color 0.2s ease;
        }
        
        /* Enhanced form field styling for edit modal */
        #editProductModal .form-field {
            margin-bottom: 0;
        }
        
        #editProductModal .form-field label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #editProductModal .form-field input {
            padding: 12px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        #editProductModal .form-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        #editProductModal .form-field input:hover:not(:focus) {
            border-color: #d1d5db;
        }
        
        /* Price and stock input styling */
        #editProductModal .price-input {
            color: #059669;
            font-weight: 600;
        }
        
        #editProductModal .stock-input {
            color: #dc2626;
            font-weight: 600;
        }
        
        /* Modal content improvements */
        #editProductModal .order-modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Better spacing for action buttons */
        #editProductModal .limits-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .input-wrapper:focus-within .input-prefix {
            color: var(--primary);
            font-weight: 700;
        }
        
        .order-id {
            font-family: monospace;
            font-weight: bold;
            color: var(--primary);
        }

        /* Column alignment and widths */
        .orders-table th:nth-child(1),
        .orders-table td:nth-child(1) { /* Order ID */
            width: 120px;
        }
        .orders-table th:nth-child(2),
        .orders-table td:nth-child(2) { /* Customer */
            width: 26%;
        }
        .orders-table th:nth-child(3),
        .orders-table td:nth-child(3) { /* Delivery Date */
            width: 140px;
            text-align: center;
        }
        .orders-table th:nth-child(4),
        .orders-table td:nth-child(4) { /* Status */
            width: 220px;
            text-align: left;
        }
        .orders-table th:nth-child(5),
        .orders-table td:nth-child(5) { /* Total */
            width: 140px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        .orders-table th:nth-child(6),
        .orders-table td:nth-child(6) { /* Actions */
            width: 140px;
            text-align: center;
        }

        .status-cell {
            display: flex;
            gap: 6px;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-confirmed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .view-details {
            background: #3b82f6; /* vivid blue for better contrast */
            color: #ffffff;
            border: 1px solid #2563eb;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.25);
        }
        
        .view-details:hover {
            background: #2563eb;
            box-shadow: 0 3px 10px rgba(37, 99, 235, 0.35);
        }
        
        .view-details:focus {
            outline: 2px solid #93c5fd;
            outline-offset: 2px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .no-orders {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-light);
            border: 1px dashed var(--border);
            border-radius: 12px;
            background: #fafafa;
        }
        
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .order-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .order-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 5;
        }
        
        .order-modal-header h3 {
            margin: 0;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .order-modal-body {
            padding: 20px;
        }
        
        .order-section {
            margin-bottom: 25px;
        }
        
        .order-section h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .order-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            font-weight: 500;
            color: var(--text);
        }
        
        .info-value {
            color: var(--text-light);
        }
        
        .cart-items {
            display: grid;
            gap: 10px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .cart-item-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .payment-proof {
            text-align: center;
        }
        
        .payment-proof img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .admin-actions { justify-content: center; width: 100%; }
            
            .orders-table {
                font-size: 0.9rem;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 8px 6px;
            }
            
            .status-filter {
                justify-content: center;
            }
            .orders-toolbar { width: 100%; justify-content: center; order: 3; }
        }
        
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
            max-width: 400px;
        }

        .toast {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            pointer-events: all;
            border-left: 4px solid #e5e7eb;
            animation: slideInRight 0.3s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .toast.removing {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        .toast-icon {
            font-size: 24px;
            line-height: 1;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .toast-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--text);
            line-height: 1.4;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.5;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 0;
            font-size: 18px;
            line-height: 1;
            opacity: 0.5;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Toast Types */
        .toast.success {
            border-left-color: #10b981;
            background: #ffffff;
        }

        .toast.success .toast-icon {
            color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
            background: #ffffff;
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
            background: #ffffff;
        }

        .toast.warning .toast-icon {
            color: #f59e0b;
        }

        .toast.info {
            border-left-color: #3b82f6;
            background: #ffffff;
        }

        .toast.info .toast-icon {
            color: #3b82f6;
        }

        /* Mobile responsiveness for toasts */
        @media (max-width: 480px) {
            .toast-container {
                left: 10px;
                right: 10px;
                top: 10px;
                max-width: none;
            }
            
            .toast {
                min-width: unset;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <div class="admin-header">
        <h1>🍰 Admin Dashboard</h1>
        <div class="admin-actions">
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="limits-container">
        <div class="orders-header">
            <h2>Products</h2>
            <div class="orders-toolbar">
                <button class="refresh-btn" id="reloadProductsBtn">Reload</button>
                <button class="save-limits-btn" id="openAddProductModalBtn">Add Product</button>
            </div>
        </div>
        <!-- Add Product Modal -->
        <div class="order-modal" id="addProductModal" style="display:none;">
            <div class="order-modal-content" style="max-width:900px;">
                <div class="order-modal-header">
                    <h3>Add Product</h3>
                    <button class="close-modal" id="closeAddProductModal">&times;</button>
                </div>
                <div class="order-modal-body">
                    <div class="filters-group" style="margin-bottom:0;">
                        <!-- Basic Product Info -->
                        <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px; width:100%; margin-bottom:20px;">
                            <div class="form-field">
                                <label for="prodId"><span class="field-icon">🆔</span> Product ID</label>
                                <input type="text" id="prodId" placeholder="e.g., taras-cookie" />
                                <small class="help-text">No spaces or special characters</small>
                            </div>
                            <div class="form-field">
                                <label for="prodTitle"><span class="field-icon">📝</span> Title</label>
                                <input type="text" id="prodTitle" placeholder="Product name" />
                            </div>
                            
                            <div class="form-field">
                                <label for="prodCat"><span class="field-icon">🏷️</span> Category</label>
                                <input type="text" id="prodCat" placeholder="cookies" />
                            </div>
                        </div>
                        <!-- Description field outside the grid for better layout -->
                        <div class="form-field" style="margin-bottom:20px;">
                            <label for="prodDesc"><span class="field-icon">📄</span> Description</label>
                            <textarea id="prodDesc" placeholder="Enter product description..." rows="3" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-family:inherit; resize:vertical; min-height:80px;"></textarea>
                            <small class="help-text">Describe your product to help customers understand what they're buying</small>
                        </div>
                        
                        <!-- Additional Images Section -->
                        <div class="form-field" style="margin-bottom:20px;">
                            <label><span class="field-icon">📸</span> Additional Images</label>
                            <div id="imageUploadContainer">
                                <div class="image-upload-item">
                                    <input type="file" class="image-file-input" accept="image/*" onchange="handleImageUpload(this)" />
                                    <button type="button" class="remove-image-btn" onclick="removeImageUpload(this)" style="display:none;">×</button>
                                </div>
                            </div>
                            <button type="button" onclick="addImageUpload()" style="margin-top: 8px; padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                + Add Another Image
                            </button>
                            <small class="help-text">Upload multiple images for product gallery (JPG, PNG, GIF)</small>
                        </div>
                        
                        <!-- Product Type Selection -->
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; font-size: 16px; font-weight: 600;">
                                <span class="field-icon">⚙️</span> Product Type
                            </h4>
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="productType" value="single" checked onchange="toggleProductType()">
                                    <span>Single Product (one price/stock)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="productType" value="variants" onchange="toggleProductType()">
                                    <span>Product with Variants (multiple sizes)</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Single Product Fields -->
                        <div id="singleProductFieldsAdd" style="display: block;">
                            <div class="variants-container">
                                <h4 style="color: var(--primary); margin-bottom: 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <span class="field-icon">💰</span> Product Pricing & Stock
                                    <span style="font-size: 12px; font-weight: 400; color: var(--text-light); margin-left: 8px;">Set price and stock for this product</span>
                                </h4>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; max-width: 500px;">
                                    <div class="form-field">
                                        <label for="prodPrice"><span class="field-icon">💰</span> Price</label>
                                        <div class="input-wrapper">
                                            <span class="input-prefix">₱</span>
                                            <input type="number" id="prodPrice" class="price-input" placeholder="0.00" step="0.01" min="0" />
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label for="prodStock"><span class="field-icon">📦</span> Stock</label>
                                        <input type="number" id="prodStock" class="stock-input" placeholder="0" step="1" min="0" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Variants Section -->
                        <div id="variantsSectionAdd" style="display: none;">
                            <div class="variants-container">
                                <h4 style="color: var(--primary); margin-bottom: 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <span class="field-icon">📏</span> Product Variants
                                    <span style="font-size: 12px; font-weight: 400; color: var(--text-light); margin-left: 8px;">Add different sizes with their own prices and stock</span>
                                </h4>
                                <div id="variantsContainerAdd">
                                    <!-- Variants will be dynamically generated here -->
                                </div>
                                <button type="button" onclick="addVariant()" style="margin-top: 15px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    + Add Variant
                                </button>
                            </div>
                        </div>
                        
                        <div class="limits-actions" style="margin-top:20px;">
                            <button class="cancel-btn" type="button" id="cancelAddProductBtn">Cancel</button>
                            <button class="save-limits-btn" type="button" id="submitProductBtn">💾 Save Product</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Product Modal -->
        <div class="order-modal" id="editProductModal" style="display:none;">
            <div class="order-modal-content" style="max-width:900px;">
                <div class="order-modal-header">
                    <h3>Edit Product</h3>
                    <button class="close-modal" id="closeEditProductModal">&times;</button>
                </div>
                <div class="order-modal-body">
                    <div class="filters-group" style="margin-bottom:0;">
                        <!-- Basic Product Info -->
                        <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px; width:100%; margin-bottom:20px;">
                            <div class="form-field">
                                <label for="editProdId"><span class="field-icon">🆔</span> Product ID</label>
                                <input type="text" id="editProdId" placeholder="product-id" readonly />
                                <small class="help-text">Cannot be changed</small>
                            </div>
                            <div class="form-field">
                                <label for="editProdTitle"><span class="field-icon">📝</span> Title</label>
                                <input type="text" id="editProdTitle" placeholder="Product name" />
                            </div>
                            
                            <div class="form-field">
                                <label for="editProdCat"><span class="field-icon">🏷️</span> Category</label>
                                <input type="text" id="editProdCat" placeholder="cookies" />
                            </div>
                        </div>
                        <!-- Description field outside the grid for better layout -->
                        <div class="form-field" style="margin-bottom:20px;">
                            <label for="editProdDesc"><span class="field-icon">📄</span> Description</label>
                            <textarea id="editProdDesc" placeholder="Enter product description..." rows="3" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-family:inherit; resize:vertical; min-height:80px;"></textarea>
                            <small class="help-text">Describe your product to help customers understand what they're buying</small>
                        </div>
                        
                        <!-- Additional Images Section -->
                        <div class="form-field" style="margin-bottom:20px;">
                            <label><span class="field-icon">📸</span> Additional Images</label>
                            <div id="editImageUploadContainer">
                                <div class="image-upload-item">
                                    <input type="file" class="image-file-input" accept="image/*" onchange="handleImageUpload(this, 'editImageUploadContainer')" />
                                    <button type="button" class="remove-image-btn" onclick="removeImageUpload(this)" style="display:none;">×</button>
                                </div>
                            </div>
                            <button type="button" onclick="addImageUpload('editImageUploadContainer')" style="margin-top: 8px; padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                + Add Another Image
                            </button>
                            <small class="help-text">Upload multiple images for product gallery (JPG, PNG, GIF)</small>
                        </div>
                        
                        <!-- Variants Section -->
                        <div id="variantsSection" style="display: none;">
                            <div class="variants-container">
                                <h4 style="color: var(--primary); margin-bottom: 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <span class="field-icon">📏</span> Product Variants
                                    <span style="font-size: 12px; font-weight: 400; color: var(--text-light); margin-left: 8px;">Edit prices and stock for each size</span>
                                </h4>
                                <div id="variantsContainer">
                                    <!-- Variants will be dynamically generated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Single Product Fields (for products without variants) -->
                        <div id="singleProductFields" style="display: none;">
                            <div class="variants-container">
                                <h4 style="color: var(--primary); margin-bottom: 20px; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                                    <span class="field-icon">💰</span> Product Pricing & Stock
                                    <span style="font-size: 12px; font-weight: 400; color: var(--text-light); margin-left: 8px;">Set price and stock for this product</span>
                                </h4>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; max-width: 500px;">
                                    <div class="form-field">
                                        <label for="editProdPrice"><span class="field-icon">💰</span> Price</label>
                                        <div class="input-wrapper">
                                            <span class="input-prefix">₱</span>
                                            <input type="number" id="editProdPrice" class="price-input" placeholder="0.00" step="0.01" min="0" />
                                        </div>
                                    </div>
                                    <div class="form-field">
                                        <label for="editProdStock"><span class="field-icon">📦</span> Stock</label>
                                        <input type="number" id="editProdStock" class="stock-input" placeholder="0" step="1" min="0" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Action Buttons at Bottom -->
                <div class="order-modal-footer" style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 12px;">
                    <button class="cancel-btn" type="button" id="cancelEditProductBtn">Cancel</button>
                    <button class="save-limits-btn" type="button" id="submitEditProductBtn">✅ Update Product</button>
                </div>
            </div>
        </div>
        <div id="productsContent">
            <div class="loading">Loading products...</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalOrders">-</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="pendingOrders">-</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalRevenue">-</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgOrderValue">-</div>
            <div class="stat-label">Avg Order Value</div>
        </div>
    </div>
    
    <div class="orders-container">
        <div class="orders-header">
            <h2>Orders</h2>
            <div class="orders-toolbar">
                <button class="export-btn" id="exportBtn">Export to Excel</button>
                <button class="refresh-btn" id="refreshBtn">Refresh</button>
            </div>
                <div class="filters-group">
                    <div class="status-filter">
                        <button class="status-btn active" data-status="all">All</button>
                        <button class="status-btn" data-status="pending">Pending</button>
                        <button class="status-btn" data-status="confirmed">Confirmed</button>
                        <button class="status-btn" data-status="completed">Completed</button>
                        <button class="status-btn" data-status="cancelled">Cancelled</button>
                    </div>
                    <div class="date-filter">
                        <label for="startDate">From</label>
                        <input type="date" id="startDate">
                        <label for="endDate">To</label>
                        <input type="date" id="endDate">
                        <div class="preset-filter">
                            <button type="button" class="preset-btn" data-preset="today">Today</button>
                            <button type="button" class="preset-btn" data-preset="last7">Last 7 Days</button>
                            <button type="button" class="preset-btn" data-preset="month">This Month</button>
                        </div>
                        <button id="clearFiltersBtn" class="clear-filters-btn">Clear</button>
                    </div>
                </div>
        </div>
        
        // submitEditProduct handler is attached below (see DOMContentLoaded)

        <div id="ordersContent">
            <div class="loading">Loading orders...</div>
        </div>
    </div>

    <div class="limits-container">
        <div class="orders-header">
            <h2>Product Limits</h2>
            <div class="orders-toolbar">
                <button class="refresh-btn" id="reloadLimitsBtn">Reload</button>
                <button class="save-limits-btn" id="saveLimitsBtn">Save Limits</button>
            </div>
        </div>
        <div id="limitsContent">
            <div class="loading">Loading limits...</div>
        </div>
    </div>

    <div class="limits-container">
        <div class="orders-header">
            <h2>📅 Pickup Dates Management</h2>
            <div class="orders-toolbar">
                <button class="refresh-btn" id="reloadDatesBtn">Reload</button>
            </div>
        </div>
        
        <div class="dates-management">
            <div class="date-type-selector">
                <label>
                    <input type="radio" name="dateType" value="pickup" checked>
                    <span>🏪 Pickup Dates</span>
                </label>
            </div>

            <div class="add-date-section">
                <h4>Add New Available Date</h4>
                <div class="date-input-group">
                    <div class="form-field">
                        <label for="newDate">Date:</label>
                        <input type="date" id="newDate" min="">
                    </div>
                    
                    <div class="form-field">
                        <label for="newDateSlots">Available Slots:</label>
                        <input type="number" id="newDateSlots" min="1" max="50" value="10" placeholder="Max orders for this date">
                    </div>
                    
                    <div class="form-field">
                        <label for="newDateNotes">Notes (optional):</label>
                        <input type="text" id="newDateNotes" placeholder="e.g., 'Morning only', 'After 2 PM'">
                    </div>
                    
                    <button type="button" id="addDateBtn" class="add-date-btn">➕ Add Date</button>
                </div>
            </div>

            <div class="available-dates-section">
                <h4>Current Available Dates</h4>
                <div class="dates-list" id="datesList">
                    <div class="loading">Loading dates...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div class="order-modal" id="orderModal">
        <div class="order-modal-content">
            <div class="order-modal-header">
                <h3 id="modalOrderId">Order Details</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="order-modal-body" id="modalBody">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Toast Notification System
        function showToast(title, message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Icon based on type
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠',
                info: 'ℹ'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" aria-label="Close notification">×</button>
            `;
            
            // Add to container
            container.appendChild(toast);
            
            // Close button functionality
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    removeToast(toast);
                }, duration);
            }
            
            return toast;
        }

        function removeToast(toast) {
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }
    
        const phpCurrency = new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' });
        let allOrders = [];
        let filteredOrders = [];
            let currentStatus = 'all';
            let currentStartDate = '';
            let currentEndDate = '';

            function toDateKey(date) {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            function normalizeDeliveryDateString(raw) {
                if (!raw) return '';
                const s = String(raw).trim();
                // ISO like 2025-10-13T00:00:00Z -> take first 10
                if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0, 10);
                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // YYYY-MM-DD
                const slash = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // MM/DD/YYYY
                if (slash) {
                    const mm = String(Number(slash[1])).padStart(2, '0');
                    const dd = String(Number(slash[2])).padStart(2, '0');
                    const yyyy = slash[3];
                    return `${yyyy}-${mm}-${dd}`;
                }
                const ySlash = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/); // YYYY/MM/DD
                if (ySlash) {
                    const yyyy = ySlash[1];
                    const mm = String(Number(ySlash[2])).padStart(2, '0');
                    const dd = String(Number(ySlash[3])).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
                const parsed = new Date(s);
                if (!isNaN(parsed)) return toDateKey(parsed);
                return '';
            }
        
        // Check authentication
        // Cookie-based auth; rely on server verification
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Quick auth check to prevent flash-redirect loop
            try {
                const me = await fetch('/api/admin/me', { credentials: 'include', headers: authHeader() });
                if (me.status === 401) {
                    window.location.href = 'admin-login.html';
                    return;
                }
            } catch (_) {
                // If check fails, fallback to trying to load
            }
            loadOrders();
            // Initialize admin products and limits panels
            loadProductsAdmin();
            loadLimits();
            loadAvailableDates();
            
            // Event listeners
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('refreshBtn').addEventListener('click', loadOrders);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('reloadLimitsBtn').addEventListener('click', loadLimits);
            document.getElementById('saveLimitsBtn').addEventListener('click', saveLimits);
            document.getElementById('reloadProductsBtn').addEventListener('click', loadProductsAdmin);
            document.getElementById('openAddProductModalBtn').addEventListener('click', openAddProductModal);
            document.getElementById('submitProductBtn').addEventListener('click', addProductFromForm);
            document.getElementById('closeAddProductModal').addEventListener('click', closeAddProductModal);
            document.getElementById('cancelAddProductBtn').addEventListener('click', closeAddProductModal);
            document.getElementById('closeEditProductModal').addEventListener('click', closeEditProductModal);
            document.getElementById('cancelEditProductBtn').addEventListener('click', closeEditProductModal);
            
            // Dates management event listeners
            document.getElementById('reloadDatesBtn').addEventListener('click', loadAvailableDates);
            document.getElementById('addDateBtn').addEventListener('click', addDate);
            
            // Date type selector (pickup only)
            currentDateType = 'pickup';
            
            // Set minimum date for new date input
            setMinDate();
            document.getElementById('submitEditProductBtn').addEventListener('click', submitEditProduct);
            
            // Prevent add product modal from closing when clicking outside
            document.getElementById('addProductModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    // Don't close when clicking outside - keep the form open
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // Prevent edit product modal from closing when clicking outside
            document.getElementById('editProductModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    // Don't close when clicking outside - keep the form open
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // Status filter buttons (scoped to status filter only)
            document.querySelectorAll('.status-filter .status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentStatus = this.dataset.status;
                    applyFilters();
                });
            });
            
            // Date range inputs
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            
            startDateInput.addEventListener('change', () => {
                currentStartDate = startDateInput.value;
                applyFilters();
            });
            endDateInput.addEventListener('change', () => {
                currentEndDate = endDateInput.value;
                applyFilters();
            });
            
            // Preset buttons
            document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    const todayStr = `${yyyy}-${mm}-${dd}`;
                    
                    let startStr = '';
                    let endStr = '';
                    
                    if (btn.dataset.preset === 'today') {
                        startStr = todayStr;
                        endStr = todayStr;
                    } else if (btn.dataset.preset === 'last7') {
                        const start = new Date(today);
                        start.setDate(start.getDate() - 6);
                        const sYYYY = start.getFullYear();
                        const sMM = String(start.getMonth() + 1).padStart(2, '0');
                        const sDD = String(start.getDate()).padStart(2, '0');
                        startStr = `${sYYYY}-${sMM}-${sDD}`;
                        endStr = todayStr;
                    } else if (btn.dataset.preset === 'month') {
                        const start = new Date(yyyy, today.getMonth(), 1);
                        const end = new Date(yyyy, today.getMonth() + 1, 0); // last day of month
                        const sYYYY = start.getFullYear();
                        const sMM = String(start.getMonth() + 1).padStart(2, '0');
                        const sDD = String(start.getDate()).padStart(2, '0');
                        const eYYYY = end.getFullYear();
                        const eMM = String(end.getMonth() + 1).padStart(2, '0');
                        const eDD = String(end.getDate()).padStart(2, '0');
                        startStr = `${sYYYY}-${sMM}-${sDD}`;
                        endStr = `${eYYYY}-${eMM}-${eDD}`;
                    }
                    
                    startDateInput.value = startStr;
                    endDateInput.value = endStr;
                    currentStartDate = startStr;
                    currentEndDate = endStr;
                    applyFilters();
                });
            });
            clearFiltersBtn.addEventListener('click', () => {
                // Reset status to all
                currentStatus = 'all';
                document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.status-btn[data-status="all"]').classList.add('active');
                // Reset dates
                currentStartDate = '';
                currentEndDate = '';
                startDateInput.value = '';
                endDateInput.value = '';
                applyFilters();
            });
            
            // Close modal on backdrop click (only for order modal)
            document.getElementById('orderModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });

        async function loadLimits(){
            try{
                const res = await fetch('/api/admin/product-limits', { credentials: 'include', headers: authHeader() });
                if(res.status === 401){ logout(); return; }
                const data = await res.json();
                const limits = data?.limits || {};
                renderLimits(limits);
            } catch(e){
                console.error('Failed to load limits', e);
                document.getElementById('limitsContent').innerHTML = '<div class="no-orders">Failed to load limits.</div>';
            }
        }

        function renderLimits(limits){
            // derive product ids from current page products (fallback to keys present)
            const productEls = Array.from(document.querySelectorAll('.product'));
            const ids = productEls.map(el => ({ id: el.dataset.id, title: el.dataset.title }))
                .filter(p => !!p.id);
            const known = ids.length ? ids : Object.keys(limits).map(id=>({ id, title: id }));
            const html = `
                <div class="limits-grid">
                    ${known.map(p => `
                        <div class="limit-item">
                            <label for="limit-${p.id}">${p.title || p.id}</label>
                            <input type="number" id="limit-${p.id}" data-product-id="${p.id}" min="0" step="1" value="${Number(limits[p.id] ?? 0)}" />
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('limitsContent').innerHTML = html;
        }

        async function saveLimits(){
            try{
                const inputs = Array.from(document.querySelectorAll('#limitsContent [data-product-id]'));
                const payload = {};
                inputs.forEach(inp => {
                    const id = inp.getAttribute('data-product-id');
                    const val = Math.max(0, Number(inp.value) || 0);
                    payload[id] = val;
                });
                const res = await fetch('/api/admin/product-limits', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    credentials: 'include',
                    body: JSON.stringify({ limits: payload })
                });
                if(res.status === 401){ logout(); return; }
                if(!res.ok){ throw new Error('Failed to save'); }
                showToast('Limits Saved', 'Product limits have been updated successfully.', 'success');
                loadLimits();
            } catch(e){
                console.error(e);
                showToast('Save Failed', 'Could not save product limits. Please try again.', 'error');
            }
        }
        
        async function loadOrders() {
            try {
                const response = await fetch('/api/admin/orders', {
                    credentials: 'include',
                    headers: authHeader()
                });
                
                if (response.status === 401) {
                    // Stay on this page and redirect to login explicitly
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }
                
                allOrders = await response.json();
                filteredOrders = [...allOrders];
                
                updateStats(filteredOrders);
                renderOrders();
            } catch (error) {
                console.error('Error loading orders:', error);
                // Retry once shortly after initial navigation to avoid cookie propagation race
                setTimeout(async () => {
                    try {
                        const retry = await fetch('/api/admin/orders', { credentials: 'include', headers: authHeader() });
                        if (retry.ok) {
                            allOrders = await retry.json();
                            filteredOrders = [...allOrders];
                            updateStats();
                            renderOrders();
                            return;
                        }
                    } catch (_) {}
                    document.getElementById('ordersContent').innerHTML = 
                        '<div class="no-orders">Error loading orders. Please try again.</div>';
                }, 200);
            }
        }

        function authHeader() {
            const t = localStorage.getItem('admin_bearer');
            return t ? { 'Authorization': `Bearer ${t}` } : {};
        }
        
        function updateStats(source = filteredOrders) {
            const totalOrders = source.length;
            const pendingOrders = source.filter(order => order.status === 'pending').length;
            const totalRevenue = source.reduce((sum, order) => sum + parseFloat(order.total), 0);
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('totalRevenue').textContent = phpCurrency.format(totalRevenue);
            document.getElementById('avgOrderValue').textContent = phpCurrency.format(avgOrderValue);
        }
        
        function applyFilters() {
            const matchesStatus = (order) => {
                if (currentStatus === 'all') return true;
                return order.status === currentStatus;
            };
            
            const matchesDate = (order) => {
                const key = normalizeDeliveryDateString(order.delivery_date);
                if (!key) return false;
                if (currentStartDate) {
                    if (key < currentStartDate) return false;
                }
                if (currentEndDate) {
                    if (key > currentEndDate) return false;
                }
                return true;
            };
            
            // Guard: if start > end, swap
            if (currentStartDate && currentEndDate && currentStartDate > currentEndDate) {
                const tmp = currentStartDate;
                currentStartDate = currentEndDate;
                currentEndDate = tmp;
                document.getElementById('startDate').value = currentStartDate;
                document.getElementById('endDate').value = currentEndDate;
            }

            filteredOrders = allOrders.filter(o => matchesStatus(o) && matchesDate(o));
            updateStats(filteredOrders);
            renderOrders();
        }
        
        function renderOrders() {
            const container = document.getElementById('ordersContent');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="no-orders">No orders found.</div>';
                return;
            }
            
            const tableHTML = `
                <div class="table-scroll">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Delivery Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredOrders.map(order => `
                            <tr>
                                <td class="order-id">${order.id}</td>
                                <td>${order.customer_name}</td>
                                <td>${(() => { const key = normalizeDeliveryDateString(order.delivery_date); if (!key) return ''; const dt = new Date(key + 'T00:00:00'); return isNaN(dt) ? '' : dt.toLocaleDateString(); })()}</td>
                                <td>
                                    <div class="status-cell">
                                        <select id="status-${order.id}" class="status-select">
                                            ${['pending','confirmed','completed','cancelled'].map(s => `
                                                <option value="${s}" ${s===order.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>
                                            `).join('')}
                                        </select>
                                        <button class="status-save" onclick="updateOrderStatus('${order.id}', document.getElementById('status-${order.id}').value, this)">Update</button>
                                    </div>
                                </td>
                                <td>${phpCurrency.format(parseFloat(order.total) || 0)}</td>
                                <td>
                                    <button class="view-details" onclick="viewOrderDetails('${order.id}')">View Details</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        async function viewOrderDetails(orderId) {
            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) return;
                
                let parsed;
                try {
                    parsed = JSON.parse(order.cart_items);
                } catch (_) {
                    parsed = [];
                }
                const cartItems = Array.isArray(parsed) ? parsed : Object.values(parsed || {});
                
                document.getElementById('modalOrderId').textContent = `Order ${order.id}`;
                
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="order-section">
                        <h4>Customer Information</h4>
                        <div class="order-info">
                            <div class="info-row">
                                <span class="info-label">Name:</span>
                                <span class="info-value">${order.customer_name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${order.customer_email}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone:</span>
                                <span class="info-value">${order.customer_phone}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Address:</span>
                                <span class="info-value">${order.customer_address}</span>
                            </div>
                            ${order.customer_instagram ? `
                            <div class="info-row">
                                <span class="info-label">Instagram:</span>
                                <span class="info-value">${order.customer_instagram}</span>
                            </div>
                            ` : ''}
                            ${order.customer_notes ? `
                            <div class="info-row">
                                <span class="info-label">Notes:</span>
                                <span class="info-value">${order.customer_notes}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="order-section">
                        <h4>Order Details</h4>
                        <div class="order-info">
                            <div class="info-row">
                                <span class="info-label">Order ID:</span>
                                <span class="info-value">${order.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Delivery Date:</span>
                                <span class="info-value">${new Date(order.delivery_date).toLocaleDateString()}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Status:</span>
                                <span class="info-value">
                                    <span class="status-badge status-${order.status}">
                                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                                    </span>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Created:</span>
                                <span class="info-value">${new Date(order.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-section">
                        <h4>Items Ordered</h4>
                        <div class="cart-items">
                            ${cartItems.map(item => `
                                <div class="cart-item">
                                    <img src="${item.img}" alt="${item.title}">
                                    <div class="cart-item-info">
                                        <div class="cart-item-name">${item.title}</div>
                                        <div class="cart-item-details">
                                            Quantity: ${Number(item.quantity) || 0} × ${phpCurrency.format(Number(item.price) || 0)} = ${phpCurrency.format(((Number(item.quantity) || 0) * (Number(item.price) || 0)))}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="order-section">
                        <h4>Payment Information</h4>
                        <div class="order-info">
                            <div class="info-row">
                                <span class="info-label">Subtotal:</span>
                                <span class="info-value">${phpCurrency.format(parseFloat(order.subtotal) || 0)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Delivery Fee:</span>
                                <span class="info-value">${phpCurrency.format(parseFloat(order.delivery_fee) || 0)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Total:</span>
                                <span class="info-value">${phpCurrency.format(parseFloat(order.total) || 0)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-section">
                        <h4>Payment Proof</h4>
                        <div class="payment-proof">
                            <img src="/uploads/payment-proofs/${order.payment_proof}" alt="Payment Proof" onclick="window.open('/uploads/payment-proofs/${order.payment_proof}', '_blank')">
                        </div>
                    </div>
                `;
                
                document.getElementById('orderModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading order details:', error);
            }
        }

        async function updateOrderStatus(orderId, newStatus, btn) {
            try {
                if (btn) { btn.disabled = true; btn.textContent = 'Updating...'; }
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    credentials: 'include',
                    body: JSON.stringify({ status: newStatus })
                });
                if (response.status === 401) {
                    logout();
                    return;
                }
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                // Update local data
                const orderIdxAll = allOrders.findIndex(o => o.id === orderId);
                if (orderIdxAll !== -1) allOrders[orderIdxAll].status = newStatus;
                const orderIdxFiltered = filteredOrders.findIndex(o => o.id === orderId);
                if (orderIdxFiltered !== -1) filteredOrders[orderIdxFiltered].status = newStatus;
                updateStats(filteredOrders);
                renderOrders();
            } catch (e) {
                console.error(e);
                showToast('Update Failed', 'Could not update order status. Please try again.', 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Update'; }
            }
        }
        
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        async function exportToExcel() {
            try {
                const exportBtn = document.getElementById('exportBtn');
                const originalText = exportBtn.textContent;
                
                // Show loading state
                exportBtn.disabled = true;
                exportBtn.textContent = 'Exporting...';
                
                const response = await fetch('/api/admin/orders/export', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to export orders');
                }
                
                // Get the filename from the response headers
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'sweets-by-toni-orders.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('Excel export completed successfully');
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Export Failed', 'Failed to export orders to Excel. Please try again.', 'error');
            } finally {
                // Reset button state
                const exportBtn = document.getElementById('exportBtn');
                exportBtn.disabled = false;
                exportBtn.textContent = 'Export to Excel';
            }
        }

        async function loadProductsAdmin(){
            try{
                const res = await fetch('/api/products');
                const data = await res.json();
                allProducts = Array.isArray(data.products) ? data.products : [];
                renderProductsAdmin(allProducts);
            } catch(e){
                document.getElementById('productsContent').innerHTML = '<div class="no-orders">Failed to load products.</div>';
            }
        }

        function renderProductsAdmin(items){
            const html = `
                <div class="table-scroll">
                  <table class="orders-table">
                    <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Variants</th><th>Actions</th></tr></thead>
                    <tbody>
                      ${items.map(p => {
                        if (p.hasVariants && p.variants && p.variants.length > 0) {
                          // Product with variants
                          const variantsList = p.variants.map(v => 
                            `<div style="margin: 2px 0; padding: 4px 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                              <strong>${v.name}</strong> - ${phpCurrency.format(Number(v.price)||0)} (${Number(v.stock)||0} in stock)
                            </div>`
                          ).join('');
                          
                          return `
                            <tr>
                              <td>${p.id}</td>
                              <td>${p.title}</td>
                              <td><span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">With Variants</span></td>
                              <td style="max-width: 300px;">${variantsList}</td>
                              <td>
                                <button class="status-save" onclick="editProductPrompt('${p.id}')">Edit</button>
                                <button class="status-save" onclick="deleteProduct('${p.id}')">Delete</button>
                              </td>
                            </tr>
                          `;
                        } else {
                          // Regular product
                          return `
                            <tr>
                              <td>${p.id}</td>
                              <td>${p.title}</td>
                              <td><span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Single Product</span></td>
                              <td>${phpCurrency.format(Number(p.price)||0)} (${Number(p.stock)||0} in stock)</td>
                              <td>
                                <button class="status-save" onclick="editProductPrompt('${p.id}')">Edit</button>
                                <button class="status-save" onclick="deleteProduct('${p.id}')">Delete</button>
                              </td>
                            </tr>
                          `;
                        }
                      }).join('')}
                    </tbody>
                  </table>
                </div>
            `;
            document.getElementById('productsContent').innerHTML = html;
        }

        function openAddProductModal(){
            // Reset form
            document.getElementById('prodId').value = '';
            document.getElementById('prodTitle').value = '';
            document.getElementById('prodCat').value = 'cookies';
            document.getElementById('prodDesc').value = '';
            document.getElementById('prodPrice').value = '';
            document.getElementById('prodStock').value = '';
            
            // Reset to single product type
            document.querySelector('input[name="productType"][value="single"]').checked = true;
            toggleProductType();
            
            // Clear variants and reset counter
            document.getElementById('variantsContainerAdd').innerHTML = '';
            variantCounter = 0;
            
            const modal = document.getElementById('addProductModal');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }
        
        function toggleProductType() {
            const productType = document.querySelector('input[name="productType"]:checked').value;
            const singleFields = document.getElementById('singleProductFieldsAdd');
            const variantsSection = document.getElementById('variantsSectionAdd');
            
            console.log('Toggling product type to:', productType);
            
            if (productType === 'single') {
                singleFields.style.display = 'block';
                variantsSection.style.display = 'none';
            } else {
                singleFields.style.display = 'none';
                variantsSection.style.display = 'block';
                
                // Add default variants if none exist
                if (document.getElementById('variantsContainerAdd').children.length === 0) {
                    console.log('Adding default variants');
                    addVariant();
                    addVariant();
                }
            }
        }
        
        let variantCounter = 0;
        
        function addVariant() {
            const container = document.getElementById('variantsContainerAdd');
            const variantIndex = variantCounter++;
            
            console.log('Adding variant with index:', variantIndex);
            
            const variantDiv = document.createElement('div');
            variantDiv.className = 'variant-item';
            variantDiv.innerHTML = `
                <div class="variant-header">
                    <div class="variant-name">Variant ${variantIndex + 1}</div>
                    <button type="button" onclick="removeVariant(this)" style="background: #dc2626; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
                <div class="variant-fields">
                    <div class="variant-field" data-field="name">
                        <label>Variant Name</label>
                        <input type="text" data-field="name" data-index="${variantIndex}" placeholder="e.g., 10 inches" />
                    </div>
                    <div class="variant-field" data-field="size">
                        <label>Size</label>
                        <input type="text" data-field="size" data-index="${variantIndex}" placeholder="e.g., 10 inches" />
                    </div>
                    <div class="variant-field" data-field="price">
                        <label>Price</label>
                        <div class="input-wrapper">
                            <span class="input-prefix">₱</span>
                            <input type="number" data-field="price" data-index="${variantIndex}" placeholder="0.00" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="variant-field" data-field="stock">
                        <label>Stock</label>
                        <input type="number" data-field="stock" data-index="${variantIndex}" placeholder="0" step="1" min="0" />
                    </div>
                </div>
            `;
            container.appendChild(variantDiv);
            console.log('Variant added to container, total children:', container.children.length);
        }
        
        function removeVariant(button) {
            if (document.getElementById('variantsContainerAdd').children.length > 1) {
                button.closest('.variant-item').remove();
            } else {
                alert('You must have at least one variant');
            }
        }

        function closeAddProductModal(){
            const modal = document.getElementById('addProductModal');
            modal.classList.remove('open');
            // Reset form fields
            document.getElementById('prodId').value = '';
            document.getElementById('prodTitle').value = '';
            document.getElementById('prodDesc').value = '';
            document.getElementById('prodPrice').value = '';
            document.getElementById('prodStock').value = '';
            document.getElementById('prodCat').value = '';
            
            // Reset additional images
            const imageContainer = document.getElementById('imageUploadContainer');
            imageContainer.innerHTML = `
                <div class="image-upload-item">
                    <input type="file" class="image-file-input" accept="image/*" onchange="handleImageUpload(this)" />
                    <button type="button" class="remove-image-btn" onclick="removeImageUpload(this)" style="display:none;">×</button>
                </div>
            `;
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        function openEditProductModal(productData){
            document.getElementById('editProdId').value = productData.id || '';
            document.getElementById('editProdTitle').value = productData.title || '';
            document.getElementById('editProdCat').value = productData.category || 'cookies';
            document.getElementById('editProdDesc').value = productData.description || '';
            
            // Handle additional images
            const editContainer = document.getElementById('editImageUploadContainer');
            editContainer.innerHTML = ''; // Clear existing inputs
            
            // For editing, we'll show file inputs for new uploads
            // Existing images will be shown in preview but not editable
            const imageItem = document.createElement('div');
            imageItem.className = 'image-upload-item';
            imageItem.innerHTML = `
                <input type="file" class="image-file-input" accept="image/*" onchange="handleImageUpload(this, 'editImageUploadContainer')" />
                <button type="button" class="remove-image-btn" onclick="removeImageUpload(this)" style="display:none;">×</button>
            `;
            editContainer.appendChild(imageItem);
            
            // Show existing images as preview if any
            if (productData.additionalImages && productData.additionalImages.length > 0) {
                const previewContainer = document.createElement('div');
                previewContainer.className = 'image-preview';
                previewContainer.innerHTML = '<h4 style="margin: 10px 0 5px 0; font-size: 12px; color: var(--text-light);">Existing Images:</h4>';
                
                productData.additionalImages.forEach((imageUrl, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${imageUrl}" alt="Existing ${index + 1}" onerror="this.style.display='none'">
                        <div class="image-preview-label">Existing</div>
                    `;
                    previewContainer.appendChild(previewItem);
                });
                
                editContainer.appendChild(previewContainer);
            }
            
            // Update image preview
            updateImagePreview('editImageUploadContainer');
            
            // Check if product has variants
            if (productData.hasVariants && productData.variants && productData.variants.length > 0) {
                // Show variants section, hide single product fields
                document.getElementById('variantsSection').style.display = 'block';
                document.getElementById('singleProductFields').style.display = 'none';
                
                // Generate variant editing interface
                generateVariantEditInterface(productData.variants);
            } else {
                // Show single product fields, hide variants section
                document.getElementById('variantsSection').style.display = 'none';
                document.getElementById('singleProductFields').style.display = 'block';
                
                // Set single product values
                document.getElementById('editProdPrice').value = productData.price || 0;
                document.getElementById('editProdStock').value = productData.stock || 0;
            }
            
            const modal = document.getElementById('editProductModal');
            modal.style.display = 'flex';
            modal.classList.add('open');
        }

        function closeEditProductModal(){
            const modal = document.getElementById('editProductModal');
            modal.classList.remove('open');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        // Multiple Image Upload Functions
        function addImageUpload(containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            const imageItem = document.createElement('div');
            imageItem.className = 'image-upload-item';
            imageItem.innerHTML = `
                <input type="file" class="image-file-input" accept="image/*" onchange="handleImageUpload(this, '${containerId}')" />
                <button type="button" class="remove-image-btn" onclick="removeImageUpload(this)">×</button>
            `;
            container.appendChild(imageItem);
            updateRemoveButtons(containerId);
        }
        
        function removeImageUpload(button) {
            const container = button.closest('[id$="UploadContainer"]');
            button.parentElement.remove();
            updateRemoveButtons(container.id);
            updateImagePreview(container.id);
        }
        
        function updateRemoveButtons(containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            const items = container.querySelectorAll('.image-upload-item');
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-image-btn');
                if (items.length > 1) {
                    removeBtn.style.display = 'flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function updateImagePreview(containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            let previewContainer = container.querySelector('.image-preview');
            
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.className = 'image-preview';
                container.appendChild(previewContainer);
            }
            
            previewContainer.innerHTML = '';
            
            const inputs = container.querySelectorAll('.image-file-input');
            inputs.forEach((input, index) => {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}" onerror="this.style.display='none'">
                            <button type="button" class="image-preview-remove" onclick="removeImagePreview(${index}, '${containerId}')">×</button>
                        `;
                        previewContainer.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function removeImagePreview(index, containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.image-file-input');
            if (inputs[index]) {
                inputs[index].value = '';
                updateImagePreview(containerId);
            }
        }
        
        function handleImageUpload(input, containerId = 'imageUploadContainer') {
            const file = input.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('Invalid File', 'Please select an image file.', 'error');
                    input.value = '';
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File Too Large', 'Image must be less than 5MB.', 'error');
                    input.value = '';
                    return;
                }
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateImagePreview(containerId);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function getAdditionalImages(containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.image-file-input');
            const images = [];
            inputs.forEach(input => {
                if (input.files && input.files[0]) {
                    // For file uploads, we'll need to handle this differently
                    // For now, we'll store the file data as base64
                    const file = input.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        images.push(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
            return images;
        }
        
        async function uploadImages(containerId = 'imageUploadContainer') {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.image-file-input');
            const files = [];
            
            for (const input of inputs) {
                if (input.files && input.files[0]) {
                    files.push(input.files[0]);
                }
            }
            
            if (files.length === 0) return [];
            
            const formData = new FormData();
            files.forEach((file, index) => {
                formData.append('images', file);
            });
            
            try {
                const response = await fetch('/api/admin/products/images', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to upload images');
                }
                
                const result = await response.json();
                return result.imageUrls || [];
            } catch (error) {
                console.error('Image upload error:', error);
                showToast('Upload Failed', 'Failed to upload images. Please try again.', 'error');
                return [];
            }
        }
        
        async function getAdditionalImagesAsync(containerId = 'imageUploadContainer') {
            return await uploadImages(containerId);
        }

        async function addProductFromForm(){
            const idEl = document.getElementById('prodId');
            const titleEl = document.getElementById('prodTitle');
            // Main image field removed
            const catEl = document.getElementById('prodCat');

            const id = String(idEl.value || '').trim();
            const title = String(titleEl.value || '').trim();
            const img = '';
            const category = String(catEl.value || 'cookies').trim() || 'cookies';
            const descriptionRequired = String(document.getElementById('prodDesc').value || '').trim();

            if(!id){ showToast('ID Required', 'Please enter a product ID.', 'warning'); return; }
            if(/\s/.test(id)){ showToast('Invalid ID', 'Product ID must not contain spaces.', 'warning'); return; }
            if(!title){ showToast('Title Required', 'Please enter a product title.', 'warning'); return; }

            // Get additional images
            const additionalImages = await getAdditionalImagesAsync();
            
            // Check product type
            const productType = document.querySelector('input[name="productType"]:checked').value;
            let productData = { 
                id, 
                title, 
                img, 
                category,
                description: descriptionRequired,
                additionalImages: additionalImages.length > 0 ? additionalImages : undefined
            };
            
            if (productType === 'single') {
                // Single product
                const price = Number(document.getElementById('prodPrice').value || 0);
                const stock = Number(document.getElementById('prodStock').value || 0);
                productData.price = price;
                productData.stock = stock;
                productData.hasVariants = false;
            } else {
                // Product with variants
                const variantInputs = document.querySelectorAll('#variantsContainerAdd input[data-field]');
                const variants = [];
                
                // Group inputs by index
                const variantGroups = {};
                variantInputs.forEach(input => {
                    const index = input.dataset.index;
                    const field = input.dataset.field;
                    if (!variantGroups[index]) variantGroups[index] = {};
                    variantGroups[index][field] = input.value;
                });
                
                // Convert to variants array
                Object.values(variantGroups).forEach(variantData => {
                    console.log('Processing variant data:', variantData);
                    if (variantData.name && variantData.price) { // Only add if name and price are provided
                        const variant = {
                            id: `${id}-${variantData.name.toLowerCase().replace(/\s+/g, '-')}`,
                            name: variantData.name || '',
                            size: variantData.size || variantData.name || '',
                            price: Number(variantData.price) || 0,
                            stock: Number(variantData.stock) || 0
                        };
                        console.log('Adding variant:', variant);
                        variants.push(variant);
                    }
                });
                
                console.log('All variants collected:', variants);
                
                if (variants.length === 0) {
                    showToast('Variants Required', 'Please add at least one variant with a name and price.', 'warning');
                    return;
                }
                
                productData.hasVariants = true;
                productData.variants = variants;
                console.log('Final product data for variants:', productData);
            }

            try{
                console.log('Adding product with data:', productData);
                const res = await fetch('/api/admin/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    credentials: 'include',
                    body: JSON.stringify(productData)
                });
                if(res.status === 401){ logout(); return; }
                if(!res.ok){ 
                    const err = await res.json().catch(()=>({})); 
                    console.error('Add failed:', err);
                    throw new Error(err.error||`Failed (${res.status})`); 
                }
                const result = await res.json();
                console.log('Add successful:', result);
                await loadProductsAdmin();
                closeAddProductModal();
                showToast('Product Added! 🎉', 'The product has been added successfully.', 'success');
            } catch(e){ 
                console.error('Add error:', e);
                showToast('Add Failed', e.message || 'Failed to add product. Please try again.', 'error'); 
            }
        }

        // Global variable to store all products for easy access
        let allProducts = [];

        window.editProductPrompt = async function(id){
            // Find the product data
            const product = allProducts.find(p => p.id === id);
            if(!product){
                showToast('Not Found', 'Product not found.', 'error');
                return;
            }
            // Open the edit modal with product data
            openEditProductModal(product);
        }

        function generateVariantEditInterface(variants) {
            const container = document.getElementById('variantsContainer');
            container.innerHTML = '';
            
            variants.forEach((variant, index) => {
                const variantDiv = document.createElement('div');
                variantDiv.className = 'variant-item';
                variantDiv.innerHTML = `
                    <div class="variant-header">
                        <div class="variant-name">${variant.name}</div>
                    </div>
                    <div class="variant-fields">
                        <div class="variant-field" data-field="name">
                            <label>Variant Name</label>
                            <input type="text" value="${variant.name}" data-field="name" data-index="${index}" placeholder="e.g., 10 inches" />
                        </div>
                        <div class="variant-field" data-field="size">
                            <label>Size</label>
                            <input type="text" value="${variant.size || variant.name}" data-field="size" data-index="${index}" placeholder="e.g., 10 inches" />
                        </div>
                        <div class="variant-field" data-field="price">
                            <label>Price</label>
                            <div class="input-wrapper">
                                <span class="input-prefix">₱</span>
                                <input type="number" value="${variant.price}" data-field="price" data-index="${index}" placeholder="0.00" step="0.01" min="0" />
                            </div>
                        </div>
                        <div class="variant-field" data-field="stock">
                            <label>Stock</label>
                            <input type="number" value="${variant.stock}" data-field="stock" data-index="${index}" placeholder="0" step="1" min="0" />
                        </div>
                    </div>
                `;
                container.appendChild(variantDiv);
            });
        }

        async function submitEditProduct(){
            const id = document.getElementById('editProdId').value.trim();
            const title = document.getElementById('editProdTitle').value.trim();
            const img = '';
            const category = document.getElementById('editProdCat').value.trim() || 'cookies';
            const description = document.getElementById('editProdDesc').value.trim();

            if(!id){ showToast('ID Missing', 'Product ID is missing.', 'error'); return; }
            if(!title){ showToast('Title Required', 'Please enter a product title.', 'warning'); return; }
            // Description is optional

            // Get additional images
            const additionalImages = await getAdditionalImagesAsync('editImageUploadContainer');

            // Check if this is a product with variants
            const variantsSection = document.getElementById('variantsSection');
            const isVariantProduct = variantsSection.style.display !== 'none';
            
            let updateData = { 
                id, 
                title, 
                img, 
                category,
                description,
                additionalImages: additionalImages.length > 0 ? additionalImages : undefined
            };
            
            if (isVariantProduct) {
                // Collect variant data
                const variantInputs = document.querySelectorAll('#variantsContainer input[data-field]');
                const variants = [];
                
                // Group inputs by index
                const variantGroups = {};
                variantInputs.forEach(input => {
                    const index = input.dataset.index;
                    const field = input.dataset.field;
                    if (!variantGroups[index]) variantGroups[index] = {};
                    variantGroups[index][field] = input.value;
                });
                
                // Convert to variants array
                Object.values(variantGroups).forEach((variantData, index) => {
                    // Find the original variant to preserve the ID
                    const originalVariant = allProducts.find(p => p.id === id)?.variants?.[index];
                    variants.push({
                        id: originalVariant?.id || `variant-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                        name: variantData.name || '',
                        size: variantData.size || variantData.name || '',
                        price: Number(variantData.price) || 0,
                        stock: Number(variantData.stock) || 0
                    });
                });
                
                updateData.hasVariants = true;
                updateData.variants = variants;
            } else {
                // Single product data
                const price = Number(document.getElementById('editProdPrice').value || 0);
                const stock = Number(document.getElementById('editProdStock').value || 0);
                updateData.price = price;
                updateData.stock = stock;
                updateData.hasVariants = false;
            }

            try{
                console.log('Updating product with data:', updateData);
                const res = await fetch(`/api/admin/products/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    credentials: 'include',
                    body: JSON.stringify(updateData)
                });
                if(res.status === 401){ logout(); return; }
                if(!res.ok){ 
                    const err = await res.json().catch(()=>({})); 
                    console.error('Update failed:', err);
                    throw new Error(err.error||`Failed (${res.status})`); 
                }
                const result = await res.json();
                console.log('Update successful:', result);
                await loadProductsAdmin();
                closeEditProductModal();
                showToast('Product Updated! ✨', 'The product has been updated successfully.', 'success');
            } catch(e){ 
                console.error('Update error:', e);
                showToast('Update Failed', e.message || 'Failed to update product. Please try again.', 'error'); 
            }
        }

        window.deleteProduct = async function(id){
            if(!confirm('Delete this product?')) return;
            try{
                const res = await fetch(`/api/admin/products/${id}`, {
                    method: 'DELETE',
                    headers: { ...authHeader() },
                    credentials: 'include'
                });
                if(res.status === 401){ logout(); return; }
                if(!res.ok){ throw new Error('Failed'); }
                await loadProductsAdmin();
                showToast('Product Deleted', 'The product has been removed successfully.', 'success');
            } catch(e){ showToast('Delete Failed', 'Failed to delete product. Please try again.', 'error'); }
        }
        
        // Dates Management
        let availableDates = { pickup: [] };
        let currentDateType = 'pickup';

        // Load available dates
        async function loadAvailableDates() {
            try {
                console.log('Loading available dates...');
                console.log('Auth header:', authHeader());
                
                const response = await fetch('/api/admin/available-dates', {
                    headers: authHeader(),
                    credentials: 'include'
                });
                
                console.log('Load dates response status:', response.status);
                
                if (response.status === 401) {
                    console.log('Authentication failed, logging out');
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Load dates error response:', errorText);
                    throw new Error(`Failed to load dates: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Loaded dates data:', data);
                availableDates = data.dates || { pickup: [] };
                renderDatesList();
            } catch (error) {
                console.error('Error loading dates:', error);
                showToast('Load Failed', `Failed to load available dates: ${error.message}`, 'error');
            }
        }

        // Render dates list
        function renderDatesList() {
            const datesList = document.getElementById('datesList');
            const dates = availableDates[currentDateType] || [];
            
            if (dates.length === 0) {
                datesList.innerHTML = '<div class="no-data">No available dates set</div>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            datesList.innerHTML = dates.map(date => {
                const isPast = date.date < today;
                const statusClass = isPast ? 'past' : (date.remainingSlots > 0 ? 'available' : 'full');
                const statusText = isPast ? 'Past' : (date.remainingSlots > 0 ? 'Available' : 'Full');
                
                return `
                    <div class="date-item">
                        <div class="date-info">
                            <div class="date-main">${new Date(date.date).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}</div>
                            <div class="date-details">
                                <span class="date-status ${statusClass}">${statusText}</span>
                                • ${date.remainingSlots}/${date.totalSlots} slots available
                                ${date.notes ? `• ${date.notes}` : ''}
                            </div>
                        </div>
                        <div class="date-actions">
                            <button class="edit-date-btn" onclick="editDate('${date.id}')">Edit</button>
                            <button class="delete-date-btn" onclick="deleteDate('${date.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add new date
        async function addDate() {
            const date = document.getElementById('newDate').value;
            const slots = parseInt(document.getElementById('newDateSlots').value);
            const notes = document.getElementById('newDateNotes').value.trim();
            
            console.log('Adding date:', { date, slots, notes, currentDateType });
            
            if (!date) {
                showToast('Validation Error', 'Please select a date', 'error');
                return;
            }
            
            if (slots < 1 || slots > 50) {
                showToast('Validation Error', 'Slots must be between 1 and 50', 'error');
                return;
            }
            
            // Check if date already exists
            const existingDate = availableDates[currentDateType].find(d => d.date === date);
            if (existingDate) {
                showToast('Duplicate Date', 'This date already exists for ' + currentDateType, 'error');
                return;
            }
            
            try {
                const requestData = {
                    type: currentDateType,
                    date: date,
                    totalSlots: slots,
                    notes: notes
                };
                
                console.log('Sending request:', requestData);
                console.log('Auth header:', authHeader());
                
                const response = await fetch('/api/admin/available-dates', {
                    method: 'POST',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.status === 401) {
                    showToast('Authentication Error', 'Please log in again', 'error');
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Success response:', result);
                
                // Clear form
                document.getElementById('newDate').value = '';
                document.getElementById('newDateSlots').value = '10';
                document.getElementById('newDateNotes').value = '';
                
                // Reload dates
                await loadAvailableDates();
                showToast('Date Added', 'Available date has been added successfully', 'success');
            } catch (error) {
                console.error('Error adding date:', error);
                showToast('Add Failed', `Failed to add available date: ${error.message}`, 'error');
            }
        }

        // Edit date
        async function editDate(dateId) {
            const date = availableDates[currentDateType].find(d => d.id === dateId);
            if (!date) return;
            
            const newSlots = prompt(`Edit slots for ${new Date(date.date).toLocaleDateString()}:`, date.totalSlots);
            if (newSlots === null) return;
            
            const slots = parseInt(newSlots);
            if (isNaN(slots) || slots < 1 || slots > 50) {
                showToast('Validation Error', 'Slots must be between 1 and 50', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/available-dates/${dateId}`, {
                    method: 'PUT',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        totalSlots: slots
                    })
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to update date');
                }
                
                await loadAvailableDates();
                showToast('Date Updated', 'Available date has been updated successfully', 'success');
            } catch (error) {
                console.error('Error updating date:', error);
                showToast('Update Failed', 'Failed to update available date', 'error');
            }
        }

        // Delete date
        async function deleteDate(dateId) {
            if (!confirm('Are you sure you want to delete this available date?')) return;
            
            try {
                const response = await fetch(`/api/admin/available-dates/${dateId}`, {
                    method: 'DELETE',
                    headers: authHeader(),
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to delete date');
                }
                
                await loadAvailableDates();
                showToast('Date Deleted', 'Available date has been deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting date:', error);
                showToast('Delete Failed', 'Failed to delete available date', 'error');
            }
        }

        // Set minimum date to today
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newDate').min = today;
        }

        async function logout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (_) {}
            try { localStorage.removeItem('admin_bearer'); } catch (_) {}
            window.location.href = 'admin-login.html';
        }
    </script>
</body>
</html>
